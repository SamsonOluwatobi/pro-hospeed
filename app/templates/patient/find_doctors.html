{% extends "base_main.html" %}

{% block title %}Find Doctors{% endblock %}

{% block styles %}
<!-- Add Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #doctorsMap {
        height: 400px;
        width: 100%;
        margin-bottom: 20px;
    }
    .doctor-card {
        transition: transform 0.2s;
        margin-bottom: 20px;
    }
    .doctor-card:hover {
        transform: translateY(-5px);
    }
    .search-section {
        background-color: #f8f9fa;
        padding: 30px 0;
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Search Section -->
    <section class="search-section rounded">
        <div class="container">
            <h2 class="mb-4">Find a Doctor</h2>
            <form method="POST" class="row g-3">
                {{ form.hidden_tag() }}
                <div class="col-md-6">
                    {{ form.specialization.label(class="form-label") }}
                    {{ form.specialization(class="form-select") }}
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    {{ form.submit(class="btn btn-primary") }}
                    <button type="button" id="useMyLocation" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-location-arrow"></i> Use My Location
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Map Section -->
    <div id="doctorsMap"></div>

    <!-- Doctors List -->
    <div class="row" id="doctorsList">
        {% if doctors %}
            {% for doctor in doctors %}
                <div class="col-md-6 col-lg-4">
                    <div class="card doctor-card h-100">
                        <div class="card-body">
                            <h5 class="card-title">Dr. {{ doctor.username }}</h5>
                            <p class="card-text">
                                <strong>Specialization:</strong> {{ doctor.specialization|title }}<br>
                                <strong>Location:</strong> {{ doctor.clinic_address }}<br>
                                <span class="distance-text" data-lat="{{ doctor.latitude }}" data-lng="{{ doctor.longitude }}">
                                    Calculating distance...
                                </span>
                            </p>
                            <div class="d-grid">
                                <a href="{{ url_for('patient.book_appointment', doctor_id=doctor.id) }}" 
                                   class="btn btn-primary">Book Appointment</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center">
                <p class="text-muted">No doctors found matching your criteria</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map = null;
    let userMarker = null;
    let doctorMarkers = [];
    let userPosition = null;
    const doctorsData = JSON.parse('{{ doctors|tojson|safe }}');

    // Initialize map
    function initMap() {
        map = L.map('doctorsMap').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
    }

    // Add doctor markers to map
    function addDoctorMarkers() {
        doctorsData.forEach(doctor => {
            const marker = L.marker([doctor.latitude, doctor.longitude])
                .bindPopup(`
                    <strong>Dr. ${doctor.username}</strong><br>
                    ${doctor.specialization}<br>
                    <a href="/patient/book-appointment/${doctor.id}" class="btn btn-sm btn-primary mt-2">Book Appointment</a>
                `);
            doctorMarkers.push(marker);
            marker.addTo(map);
        });
        
        if (doctorsData.length > 0) {
            const bounds = L.latLngBounds(doctorsData.map(d => [d.latitude, d.longitude]));
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    }

    // Calculate distance between two points
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Earth's radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                 Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                 Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c).toFixed(1);
    }

    // Update distances for all doctors
    function updateDistances() {
        if (!userPosition) return;
        
        document.querySelectorAll('.distance-text').forEach(elem => {
            const doctorLat = parseFloat(elem.dataset.lat);
            const doctorLng = parseFloat(elem.dataset.lng);
            const distance = calculateDistance(
                userPosition.lat,
                userPosition.lng,
                doctorLat,
                doctorLng
            );
            elem.textContent = `Distance: ${distance} km`;
        });
    }

    // Handle "Use My Location" button
    document.getElementById('useMyLocation').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userPosition = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    if (userMarker) {
                        userMarker.setLatLng([userPosition.lat, userPosition.lng]);
                    } else {
                        userMarker = L.marker([userPosition.lat, userPosition.lng], {
                            icon: L.divIcon({
                                html: '<i class="fas fa-user-circle fa-2x text-primary"></i>',
                                className: 'user-marker'
                            })
                        }).addTo(map);
                    }
                    
                    map.setView([userPosition.lat, userPosition.lng], 12);
                    updateDistances();
                },
                function(error) {
                    alert('Error getting location: ' + error.message);
                }
            );
        } else {
            alert('Geolocation is not supported by your browser');
        }
    });

    // Initialize map and markers
    initMap();
    addDoctorMarkers();
});
</script>
{% endblock %} 