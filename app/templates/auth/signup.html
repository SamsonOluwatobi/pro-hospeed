{% extends "base.html" %}

{% block title %}Sign Up{% endblock %}

{% block styles %}
<!-- Add Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    #map {
        height: 300px;
        width: 100%;
        margin-bottom: 15px;
        display: none;
    }
    .location-input-group {
        margin-bottom: 15px;
    }
    .coordinates-group {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">Sign Up</h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="">
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            {{ form.username.label(class="form-label") }}
                            {{ form.username(class="form-control") }}
                            {% for error in form.username.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control") }}
                            {% for error in form.email.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ form.password.label(class="form-label") }}
                            {{ form.password(class="form-control") }}
                            {% for error in form.password.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ form.password2.label(class="form-label") }}
                            {{ form.password2(class="form-control") }}
                            {% for error in form.password2.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        <div class="mb-3">
                            {{ form.user_type.label(class="form-label") }}
                            {{ form.user_type(class="form-control") }}
                            {% for error in form.user_type.errors %}
                                <span class="text-danger">{{ error }}</span>
                            {% endfor %}
                        </div>
                        
                        <!-- Doctor-specific fields -->
                        <div id="doctor-fields" style="display: none;">
                            <div class="mb-3">
                                {{ form.specialization.label(class="form-label") }}
                                {{ form.specialization(class="form-control") }}
                                {% for error in form.specialization.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                {{ form.license_number.label(class="form-label") }}
                                {{ form.license_number(class="form-control") }}
                                {% for error in form.license_number.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                {{ form.clinic_address.label(class="form-label") }}
                                {{ form.clinic_address(class="form-control", rows=3) }}
                                {% for error in form.clinic_address.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                            
                            <!-- Location Selection -->
                            <div class="location-input-group">
                                {{ form.location_method.label(class="form-label") }}
                                {{ form.location_method(class="form-control") }}
                                {% for error in form.location_method.errors %}
                                    <span class="text-danger">{{ error }}</span>
                                {% endfor %}
                            </div>
                            
                            <!-- Map for location picking -->
                            <div id="map"></div>
                            
                            <!-- Manual coordinates input -->
                            <div class="coordinates-group">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.latitude.label(class="form-label") }}
                                            {{ form.latitude(class="form-control") }}
                                            {% for error in form.latitude.errors %}
                                                <span class="text-danger">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.longitude.label(class="form-label") }}
                                            {{ form.longitude(class="form-control") }}
                                            {% for error in form.longitude.errors %}
                                                <span class="text-danger">{{ error }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
                <div class="card-footer text-center">
                    Already have an account? <a href="{{ url_for('auth.login') }}">Login here</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userTypeSelect = document.getElementById('user_type');
    const doctorFields = document.getElementById('doctor-fields');
    const locationMethodSelect = document.getElementById('location_method');
    const mapDiv = document.getElementById('map');
    const coordinatesGroup = document.querySelector('.coordinates-group');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    
    let map = null;
    let marker = null;
    
    function toggleDoctorFields() {
        if (userTypeSelect.value === 'doctor') {
            doctorFields.style.display = 'block';
        } else {
            doctorFields.style.display = 'none';
        }
    }
    
    function initMap() {
        if (!map) {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                updateMarker(lat, lng);
            });
        }
    }
    
    function updateMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        latitudeInput.value = lat;
        longitudeInput.value = lng;
        map.setView([lat, lng], 13);
    }
    
    function handleLocationMethod() {
        mapDiv.style.display = 'none';
        coordinatesGroup.style.display = 'none';
        
        switch(locationMethodSelect.value) {
            case 'manual':
                coordinatesGroup.style.display = 'block';
                break;
            case 'map':
                mapDiv.style.display = 'block';
                initMap();
                if (!marker) {
                    // Default to a central location if no marker exists
                    updateMarker(0, 0);
                }
                // Trigger a resize event to ensure the map renders correctly
                setTimeout(() => map.invalidateSize(), 100);
                break;
            case 'current':
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude.toFixed(6);
                            const lng = position.coords.longitude.toFixed(6);
                            latitudeInput.value = lat;
                            longitudeInput.value = lng;
                            
                            // Also update map if it exists
                            if (map) {
                                updateMarker(lat, lng);
                            }
                        },
                        function(error) {
                            alert('Error getting location: ' + error.message);
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser');
                }
                break;
        }
    }
    
    userTypeSelect.addEventListener('change', toggleDoctorFields);
    locationMethodSelect.addEventListener('change', handleLocationMethod);
    
    // Initial state
    toggleDoctorFields();
    if (locationMethodSelect.value) {
        handleLocationMethod();
    }
});
</script>
{% endblock %}
